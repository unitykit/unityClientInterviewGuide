# åç¨‹åŸç†

# é¢è¯•é¢˜

1. **åç¨‹ä¸çº¿ç¨‹çš„åŒºåˆ«ï¼Ÿ**

- **åç¨‹**ï¼šä¸»çº¿ç¨‹ä¸²è¡Œæ‰§è¡Œï¼Œæ— å¹¶å‘ï¼Œé¿å…çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚
- **çº¿ç¨‹**ï¼šå¹¶è¡Œæ‰§è¡Œï¼Œéœ€å¤„ç†åŒæ­¥é”ï¼Œä½†Unityä¸­æ— æ³•ç›´æ¥æ“ä½œæ¸¸æˆå¯¹è±¡ã€‚

2. **å¦‚ä½•å®ç°è‡ªå®šä¹‰ç­‰å¾…æ¡ä»¶ï¼Ÿ**
    ç»§æ‰¿`CustomYieldInstruction`ï¼Œé‡å†™`keepWaiting`å±æ€§ï¼š

```js
class WaitForEvent : CustomYieldInstruction {
    public override bool keepWaiting => !eventTriggered;
}
// ä½¿ç”¨ï¼šyield return new WaitForEvent();
```

3. **åç¨‹çš„åµŒå¥—æ‰§è¡ŒåŸç†ï¼Ÿ**
    `yield return StartCoroutine(Child())`ä¼šç­‰å¾…å­åç¨‹å®Œæˆå†ç»§ç»­ï¼Œé€šè¿‡åµŒå¥—çŠ¶æ€æœºç®¡ç†ã€‚

4. **åç¨‹ä¸ºä½•ä¸èƒ½è¿”å›å€¼ï¼Ÿ**

 	 Unityåç¨‹çš„æœ¬è´¨æ˜¯è¿­ä»£å™¨ï¼Œæ ¸å¿ƒå®šä½æ˜¯æ§åˆ¶ä»£ç æ‰§è¡Œæµç¨‹ï¼ˆå¦‚å»¶æ—¶ã€ç­‰å¾…äº‹ä»¶ï¼‰ï¼Œè€Œéä¼ é€’è®¡ç®—ç»“æœã€‚

åç¨‹ç”±Unityä¸»çº¿ç¨‹çš„æ›´æ–°å¾ªç¯è°ƒåº¦ï¼ˆå¦‚ Update åï¼‰ã€‚StartCoroutine ä»…è¿”å›ä¸€ä¸ª Coroutine å¯¹è±¡ç”¨äºæ§åˆ¶åç¨‹ç”Ÿå‘½å‘¨æœŸï¼ˆå¦‚åœæ­¢ï¼‰ï¼Œä¸æä¾›è·å–è¿”å›å€¼çš„æ¥å£ã€‚

  è‹¥åç¨‹è¿”å›å€¼ï¼Œå…¶è¯­ä¹‰ä¼šä¸ IEnumerator çš„ Current å±æ€§å†²çªã€‚ä¾‹å¦‚ï¼Œyield return 1 å·²ç»å ç”¨ Current ä¼ é€’ç­‰å¾…æŒ‡ä»¤ï¼Œæ— æ³•åŒæ—¶ä¼ é€’è®¡ç®—ç»“æœ ã€‚

å…¶åŸºäºè¿­ä»£å™¨çš„è®¾è®¡æ›´æ³¨é‡æµç¨‹è°ƒåº¦è€Œéæ•°æ®äº¤äº’ï¼Œè¿™æ˜¯æ— æ³•è¿”å›å€¼çš„æ ¹æœ¬åŸå› ã€‚å¯¹äºéœ€è¦è¿”å›å€¼çš„å¼‚æ­¥åœºæ™¯ï¼Œå»ºè®®ä½¿ç”¨å›è°ƒã€UniTask æˆ– C# Taskï¼ˆéœ€æ³¨æ„çº¿ç¨‹åˆ‡æ¢ï¼‰ç­‰æ–¹æ¡ˆ  ã€‚

5. **åç¨‹ä¸UniTaskçš„å¯¹æ¯”ï¼Ÿ**

 	UniTaskæ”¯æŒå¼‚æ­¥è¿”å›å€¼ï¼Œå‡å°‘GCï¼Œä½†åç¨‹æ›´è½»é‡ã€‚

6. **å¦‚ä½•å®ç°åç¨‹è¶…æ—¶æœºåˆ¶ï¼Ÿ**
    ç»“åˆ`CustomYieldInstruction`è‡ªå®šä¹‰æ¡ä»¶ç­‰å¾…ã€‚

## åŸç†

åç¨‹å¹¶éçº¿ç¨‹ï¼Œè€Œæ˜¯é€šè¿‡C#çš„`IEnumerator`è¿­ä»£å™¨å®ç°çš„çŠ¶æ€æœºï¼Œç”±Unityå¼•æ“åœ¨ä¸»çº¿ç¨‹ä¸­è°ƒåº¦æ‰§è¡Œã€‚**åç¨‹çš„æœ¬è´¨ï¼šåŸºäºC#è¿­ä»£å™¨çš„çŠ¶æ€æœºã€‚**

åç¨‹ = C#è¿­ä»£å™¨çŠ¶æ€æœº + Unityä¸»çº¿ç¨‹è°ƒåº¦
ç”Ÿå‘½å‘¨æœŸç»‘å®šéš`GameObject`é”€æ¯è‡ªåŠ¨ç»ˆæ­¢ï¼Œç¦ç”¨è„šæœ¬ï¼ˆenabled=falseï¼‰ä¸ç»ˆæ­¢åç¨‹ï¼

æ€§èƒ½ä¼˜åŒ–ï¼šé¿å…é¢‘ç¹åˆ›å»ºyieldå¯¹è±¡ï¼Œåˆ†å¸§å¤„ç†è€—æ—¶é€»è¾‘

**å·¥ä½œæµç¨‹**

- **çŠ¶æ€æœºè½¬æ¢**ï¼šç¼–è¯‘å™¨å°†åç¨‹å‡½æ•°è½¬æ¢ä¸ºéšè—ç±»ï¼Œæ¯ä¸ª`yield return`å¯¹åº”ä¸€ä¸ªçŠ¶æ€ç¼–å·ï¼Œå±€éƒ¨å˜é‡æå‡ä¸ºç±»çš„å­—æ®µã€‚
- **æ¢å¤æ‰§è¡Œ**ï¼š`MoveNext()`æ–¹æ³•ä»ä¸Šæ¬¡æš‚åœçš„ä½ç½®ç»§ç»­æ‰§è¡Œï¼Œç›´åˆ°ä¸‹ä¸€ä¸ª`yield`æˆ–ç»“æŸã€‚

**è°ƒåº¦æ—¶æœº**ï¼šåç¨‹åœ¨Unityä¸»å¾ªç¯çš„ç‰¹å®šé˜¶æ®µè¢«å”¤é†’

![img](assets/1753859901351-05fb5f94-38ea-4ba8-9c73-37e87c83f4f7.png)

**æ¢å¤æ¡ä»¶**

- `yield return null` â†’ Updateåã€LateUpdateå‰æ¢å¤ã€‚
- `yield return WaitForSeconds(2)` â†’ å¼•æ“è®°å½•ç›®æ ‡æ—¶é—´ï¼Œæ¯å¸§æ£€æŸ¥æ—¶é—´æ˜¯å¦åˆ°è¾¾ã€‚
- `yield return WaitForEndOfFrame` â†’ æ‰€æœ‰æ¸²æŸ“å®Œæˆåæ¢å¤ã€‚

**é¢å¤–**

- **yield** åœ¨ä¸‹ä¸€å¸§ä¸Šè°ƒç”¨æ‰€æœ‰ Update å‡½æ•°åï¼Œåç¨‹å°†ç»§ç»­ã€‚
- **yield WaitForSeconds** åœ¨ä¸ºå¸§è°ƒç”¨æ‰€æœ‰ Update å‡½æ•°åï¼Œåœ¨æŒ‡å®šçš„æ—¶é—´å»¶è¿Ÿåç»§ç»­ã€‚
- **yield WaitForFixedUpdate** åœ¨æ‰€æœ‰è„šæœ¬ä¸Šè°ƒç”¨æ‰€æœ‰ FixedUpdate åç»§ç»­ã€‚å¦‚æœååŒç¨‹åºåœ¨ FixedUpdate ä¹‹å‰ç”Ÿæˆï¼Œé‚£ä¹ˆå®ƒä¼šåœ¨å½“å‰å¸§çš„ FixedUpdate ä¹‹åç»§ç»­è¿è¡Œã€‚
- **yield WWW** åœ¨ WWW ä¸‹è½½å®Œæˆåç»§ç»­ã€‚
- **yield StartCoroutine** å°†åç¨‹é“¾æ¥èµ·æ¥ï¼Œå¹¶ä¼šç­‰å¾… MyFunc åç¨‹å…ˆå®Œæˆã€‚

**ç”Ÿå‘½å‘¨æœŸä¸ç»ˆæ­¢æ¡ä»¶**âš ï¸

- **è‡ªåŠ¨ç»ˆæ­¢**

- å½“ç»‘å®šçš„`MonoBehaviour`è¢«é”€æ¯ï¼ˆ`Destroy`ï¼‰æˆ–`GameObject`ç¦ç”¨æ—¶ï¼Œåç¨‹è‡ªåŠ¨åœæ­¢ã€‚
- **æ³¨æ„**ï¼šä»…ç¦ç”¨è„šæœ¬ï¼ˆ`enabled=false`ï¼‰**ä¸ä¼š**åœæ­¢åç¨‹ï¼

- **æ‰‹åŠ¨æ§åˆ¶**

- `StopCoroutine()`éœ€åŒ¹é…å¯åŠ¨æ–¹å¼ï¼ˆæ–¹æ³•å/IEnumeratorå¼•ç”¨ï¼‰ã€‚
- `StopAllCoroutines()`ç»ˆæ­¢å½“å‰è„šæœ¬æ‰€æœ‰åç¨‹ã€‚

## å¸¸è§„åº”ç”¨åœºæ™¯

### â±ï¸**æ—¶é—´æ§åˆ¶ä¸å»¶æ—¶æ‰§è¡Œ**

**æŠ€èƒ½å†·å´ç³»ç»Ÿ**ï¼šç®¡ç†æŠ€èƒ½é‡Šæ”¾é—´éš”ï¼Œé¿å…é¢‘ç¹è§¦å‘ã€‚

*ä¼˜åŠ¿*ï¼šä»£ç çº¿æ€§å¯è¯»ï¼Œæ— éœ€æ‰‹åŠ¨ç®¡ç†è®¡æ—¶å™¨å˜é‡ã€‚

```js
IEnumerator SkillCooldown(string skillName, float cooldownTime) {
    skillCooldowns[skillName] = true;  // æ ‡è®°å†·å´ä¸­
    yield return new WaitForSeconds(cooldownTime);
    skillCooldowns[skillName] = false; // å†·å´ç»“æŸ
}
```

**åŠ¨ç”»åºåˆ—æ§åˆ¶**ï¼šæŒ‰é¡ºåºæ’­æ”¾è§’è‰²åŠ¨ä½œæˆ–UIåŠ¨æ•ˆã€‚

*åœºæ™¯*ï¼šè¿‡åœºåŠ¨ç”»ã€æ•™ç¨‹å¼•å¯¼æ­¥éª¤ã€‚

```js
IEnumerator PlayCutscene() {
    yield return StartCoroutine(ShowDialogue());
    yield return new WaitForSeconds(1f);
    yield return StartCoroutine(PlayCharacterAnimation());
}
```

### ğŸŒˆ**æ¸å˜ä¸è¿‡æ¸¡æ•ˆæœ**

**UIæ·¡å…¥æ·¡å‡º**ï¼šå¹³æ»‘æ”¹å˜é€æ˜åº¦å®ç°è§†è§‰è¿‡æ¸¡ã€‚

*å…³é”®ç‚¹*ï¼šé€šè¿‡`yield return null`å®ç°å¸§ç‡æ— å…³çš„å¹³æ»‘æ’å€¼ã€‚

```js
IEnumerator FadeIn(Image image, float duration) {
    float elapsed = 0;
    while (elapsed < duration) {
        image.color = new Color(1, 1, 1, elapsed / duration); // é€æ˜åº¦æ¸å˜
        elapsed += Time.deltaTime;
        yield return null; // æ¯å¸§æ›´æ–°
    }
}
```

**åŠ¨æ€ç›¸æœºç‰¹æ•ˆ**ï¼šéœ‡åŠ¨ã€å¹³æ»‘è·Ÿéšç­‰ã€‚

*åº”ç”¨*ï¼šå—å‡»åé¦ˆã€çˆ†ç‚¸æ•ˆæœã€‚

```js
IEnumerator CameraShake(float intensity) {
    Vector3 originPos = transform.position;
    while (/*éœ‡åŠ¨æ¡ä»¶*/) {
        transform.position = originPos + Random.insideUnitSphere * intensity;
        yield return null;
    }
}
```

### âš¡**åˆ†å¸§å¤„ç†ä¸å¼‚æ­¥åŠ è½½**

- **åˆ†å¸§å¤„ç†å¤§æ•°æ®**ï¼šé¿å…å•å¸§å¡é¡¿ã€‚

*é€‚ç”¨åœºæ™¯*ï¼šå¤§å‹åœ°å›¾ç”Ÿæˆã€æ‰¹é‡NPCåˆ›å»ºã€‚

```js
IEnumerator GenerateMap(int tileCount) {
    for (int i = 0; i < tileCount; i++) {
        Instantiate(tilePrefab, GetPosition(i));
        if (i % 10 == 0) yield return null; // æ¯10ä¸ªç‰©ä½“æš‚åœä¸€å¸§
    }
}
```

**èµ„æºå¼‚æ­¥åŠ è½½**ï¼šç»“åˆ`ResourceRequest`å®ç°æ— å¡é¡¿åŠ è½½ã€‚

*å¯¹æ¯”åŒæ­¥åŠ è½½*ï¼šé¿å…ä¸»çº¿ç¨‹é˜»å¡ï¼Œæå‡æµç•…åº¦ã€‚

```js
IEnumerator LoadAssetAsync(string path) {
    ResourceRequest request = Resources.LoadAsync<GameObject>(path);
    while (!request.isDone) {
        UpdateProgressBar(request.progress); // æ›´æ–°è¿›åº¦æ¡
        yield return null;
    }
    Instantiate(request.asset); // åŠ è½½å®Œæˆåå®ä¾‹åŒ–
}
```

### ğŸ® **æ¸¸æˆæµç¨‹ä¸çŠ¶æ€æœº**

- **æ¸¸æˆé˜¶æ®µæ§åˆ¶**ï¼šç®¡ç†æˆ˜æ–—å¾ªç¯ã€å…³å¡æµç¨‹ã€‚

*ä¼˜åŠ¿*ï¼šé€»è¾‘åˆ†å±‚æ¸…æ™°ï¼Œé¿å…Updateä¸­å¤æ‚çŠ¶æ€åˆ¤æ–­ã€‚

```js
IEnumerator GameLoop() {
    while (!gameOver) {
        yield return StartCoroutine(StartPhase()); // å‡†å¤‡é˜¶æ®µ
        yield return StartCoroutine(CombatPhase()); // æˆ˜æ–—é˜¶æ®µ
        yield return StartCoroutine(RewardPhase()); // ç»“ç®—é˜¶æ®µ
    }
}
```

**AIè¡Œä¸ºåºåˆ—**ï¼šå®ç°å·¡é€»-è¿½å‡»-æ”»å‡»ç­‰çŠ¶æ€åˆ‡æ¢ã€‚

*å…³é”®æœºåˆ¶*ï¼šé€šè¿‡`yield break`å¯ä¸­æ–­å½“å‰è¡Œä¸ºï¼ˆå¦‚å·¡é€»ä¸­å‘ç°ç©å®¶ï¼‰ã€‚

```js
IEnumerator EnemyAI() {
    while (true) {
        yield return StartCoroutine(Patrol());
        if (DetectPlayer()) yield return StartCoroutine(Chase());
    }
}
```

### ğŸŒ **ç½‘ç»œè¯·æ±‚ä¸å“åº”å¤„ç†**

**å¼‚æ­¥HTTPè¯·æ±‚**ï¼šé¿å…ç­‰å¾…ç½‘ç»œå“åº”æ—¶ç•Œé¢å†»ç»“ã€‚ 

*æ³¨æ„ç‚¹*ï¼šé”™è¯¯å¤„ç†éœ€åœ¨åç¨‹å†…å®Œæˆã€‚

```js
IEnumerator FetchPlayerData() {
    UnityWebRequest request = UnityWebRequest.Get("https://api.example.com/data");
    yield return request.SendWebRequest();
    if (request.result == UnityWebRequest.Result.Success) {
        ParseData(request.downloadHandler.text);
    }
}
```

### ğŸ› ï¸ **ç‰¹æ®Šåœºæ™¯éœ€æ±‚**

- **é€å¸§æ¸²æŸ“æ§åˆ¶**

- `yield return new WaitForEndOfFrame()` ç”¨äºæˆªå›¾ã€åå¤„ç†æ•ˆæœåŒæ­¥ã€‚

- **è¶…çŸ­æ—¶åŠ¨ç”»æ§åˆ¶**

*åœºæ™¯*ï¼šå—å‡»é—ªç™½ã€ç²’å­ç‰¹æ•ˆç¬å‘ã€‚

```js
IEnumerator PlayShortAnimation() {
    animator.Play("Hit");
    yield return new WaitForSeconds(0.1f); // ç²¾ç¡®æ§åˆ¶æ’­æ”¾æ—¶é•¿
    animator.Stop();
}
```
